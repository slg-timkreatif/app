<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Admin Creative App</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .bg-grid { background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px; opacity: 0.5; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .modal-content { transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1); transform: scale(0.95); opacity: 0; }
        .modal-open .modal-content { transform: scale(1); opacity: 1; }
        
        .floating-action-area { position: fixed; bottom: 0; left: 0; right: 0; padding: 1rem; background: linear-gradient(to top, #ffffff 90%, transparent); z-index: 40; pointer-events: none; }
        .floating-action-area button { pointer-events: auto; }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden relative">

    <div id="login-screen" class="fixed inset-0 z-[100] bg-slate-50 flex flex-col items-center justify-center p-6">
        <div class="w-full max-w-xs text-center">
            <div class="w-20 h-20 bg-slate-900 rounded-3xl mx-auto mb-6 flex items-center justify-center shadow-xl shadow-slate-900/20">
                <i data-lucide="shield-check" class="w-10 h-10 text-white"></i>
            </div>
            <h1 class="text-2xl font-extrabold text-slate-900 mb-2">Admin Panel</h1>
            <p class="text-slate-500 text-sm mb-8">Masukkan PIN Keamanan untuk akses.</p>
            <input type="password" id="admin-pin-input" placeholder="PIN Admin" class="w-full text-center text-xl font-bold tracking-widest bg-white border border-slate-200 rounded-2xl py-4 mb-4 focus:ring-4 focus:ring-slate-100 outline-none shadow-sm">
            <button onclick="app.checkAuth()" class="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl shadow-lg hover:scale-[1.02] transition">Masuk Dashboard</button>
        </div>
    </div>

    <div class="bg-grid fixed inset-0 z-0 pointer-events-none"></div>

    <header class="bg-white/80 backdrop-blur-md border-b border-slate-200 px-5 py-4 flex justify-between items-center relative z-10 shrink-0">
        <div>
            <h2 class="font-extrabold text-lg text-slate-800">Dashboard</h2>
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Creative App Management</p>
        </div>
        <div class="flex gap-2">
            <button onclick="app.loadData(true)" id="btn-refresh" class="p-2.5 bg-white border border-slate-100 shadow-sm rounded-full hover:bg-slate-50 transition active:scale-90 text-slate-600">
                <i data-lucide="refresh-cw" class="w-5 h-5"></i>
            </button>
            <button onclick="app.logout()" class="p-2.5 bg-red-50 border border-red-100 shadow-sm rounded-full hover:bg-red-100 transition active:scale-90 text-red-600" title="Keluar">
                <i data-lucide="log-out" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto p-5 pb-32 relative z-10 hide-scroll" id="content-area">
        
        <div class="flex p-1 bg-slate-200/80 backdrop-blur-md rounded-xl mb-6 sticky top-0 z-30 shadow-sm">
            <button onclick="app.switchTab('menu')" id="tab-menu" class="flex-1 py-2.5 text-xs font-bold rounded-lg bg-white shadow-sm text-slate-800 transition-all">Menu</button>
            <button onclick="app.switchTab('info')" id="tab-info" class="flex-1 py-2.5 text-xs font-bold rounded-lg text-slate-500 hover:text-slate-700 transition-all">Info</button>
            <button onclick="app.switchTab('user')" id="tab-user" class="flex-1 py-2.5 text-xs font-bold rounded-lg text-slate-500 hover:text-slate-700 transition-all">User</button>
            <button onclick="app.switchTab('feedback')" id="tab-feedback" class="flex-1 py-2.5 text-xs font-bold rounded-lg text-slate-500 hover:text-slate-700 transition-all">Saran</button>
        </div>

        <div id="view-menu" class="space-y-4 pb-20">
            <div class="flex justify-between items-center mb-2 px-1">
                <span class="text-xs font-bold text-slate-400 uppercase tracking-wide">Daftar Menu Aktif</span>
                <button onclick="app.editMenu(-1)" class="flex items-center gap-2 bg-slate-900 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-md active:scale-95 transition"><i data-lucide="plus" class="w-4 h-4"></i> Menu Baru</button>
            </div>
            <div id="list-menu" class="space-y-3"></div>
        </div>

        <div id="view-info" class="hidden space-y-6 pb-24">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                <h3 class="font-bold text-sm mb-4 border-b border-slate-100 pb-3 flex items-center gap-2 text-slate-700"><i data-lucide="megaphone" class="w-4 h-4 text-blue-500"></i> Banner Informasi (Atas)</h3>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Status</label><select id="inf-status" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-3 py-2.5 text-sm outline-none focus:border-blue-500"><option value="ON">ON (Tampil)</option><option value="OFF">OFF (Sembunyi)</option></select></div>
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Warna</label><select id="inf-warna" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-3 py-2.5 text-sm outline-none focus:border-blue-500"><option value="blue">Biru (Info)</option><option value="green">Hijau (Sukses)</option><option value="red">Merah (Penting)</option></select></div>
                    </div>
                    <div><label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Isi Pesan</label><textarea id="inf-pesan" rows="2" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-3 py-2.5 text-sm outline-none focus:border-blue-500 resize-none"></textarea></div>
                </div>
            </div>
            
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                <h3 class="font-bold text-sm mb-4 border-b border-slate-100 pb-3 flex items-center gap-2 text-slate-700"><i data-lucide="image" class="w-4 h-4 text-purple-500"></i> Pop-up / Flyer</h3>
                <div class="space-y-4">
                    <div class="grid grid-cols-[1fr_2fr] gap-4">
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Status</label><select id="pop-status" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-3 py-2.5 text-sm outline-none focus:border-purple-500"><option value="ON">ON</option><option value="OFF">OFF</option></select></div>
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Judul Pop-up</label><input type="text" id="pop-judul" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-3 py-2.5 text-sm outline-none focus:border-purple-500"></div>
                    </div>
                    <div><label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Pesan Detail</label><textarea id="pop-pesan" rows="3" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-3 py-2.5 text-sm outline-none focus:border-purple-500 resize-none"></textarea></div>
                    <div><label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">URL Gambar (Opsional)</label><input type="text" id="pop-gambar" placeholder="https://..." class="w-full bg-slate-50 border border-slate-200 rounded-xl px-3 py-2.5 text-sm outline-none focus:border-purple-500 text-slate-500"></div>
                </div>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                <div class="flex justify-between items-center border-b border-slate-100 pb-3 mb-4">
                    <h3 class="font-bold text-sm flex items-center gap-2 text-slate-700"><i data-lucide="link" class="w-4 h-4 text-orange-500"></i> Link Footer</h3>
                    <input type="text" id="inf-versi" placeholder="v1.0" class="w-20 text-right text-[10px] font-bold bg-slate-50 border border-slate-200 rounded-lg px-2 py-1 outline-none focus:border-orange-500">
                </div>
                <div id="footer-list-editor" class="space-y-4"></div>
                <button onclick="app.addFooterItem()" class="mt-6 w-full py-3 bg-white text-slate-500 text-xs font-bold rounded-xl hover:bg-slate-50 border-2 border-dashed border-slate-200 hover:border-slate-300 transition flex items-center justify-center gap-2 group"><i data-lucide="plus-circle" class="w-4 h-4 group-hover:text-blue-500"></i> Tambah Link Footer</button>
            </div>
        </div>

        <div id="save-info-btn-container" class="floating-action-area hidden">
            <button onclick="app.saveInfo()" class="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl shadow-xl shadow-slate-900/20 active:scale-95 transition flex items-center justify-center gap-2"><i data-lucide="save" class="w-4 h-4"></i> Simpan Semua Pengaturan</button>
        </div>

        <div id="view-user" class="hidden h-full flex flex-col">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 mb-4 sticky top-0 z-20 flex flex-col gap-3">
                
                <div class="flex gap-2">
                    <div class="relative flex-1">
                        <i data-lucide="search" class="absolute left-3.5 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                        <input type="text" id="search-user" onkeyup="app.renderUser()" placeholder="Cari Nama / Email..." class="w-full pl-10 pr-3 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 transition">
                    </div>
                    <button onclick="app.toggleSort()" id="btn-sort" class="w-12 bg-slate-50 border border-slate-200 rounded-xl flex items-center justify-center text-slate-500 hover:text-blue-600 hover:bg-blue-50 transition shadow-sm" title="Urutkan">
                        <i data-lucide="arrow-down-up" class="w-5 h-5"></i>
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div class="relative w-full">
                        <select id="filter-unit" onchange="app.renderUser()" class="w-full pl-3 pr-6 py-2 bg-slate-50 border border-slate-200 rounded-lg text-[11px] font-bold text-slate-600 outline-none appearance-none truncate"><option value="">Semua Sekolah</option></select>
                        <i data-lucide="chevron-down" class="absolute right-2 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-400 pointer-events-none"></i>
                    </div>
                    <div class="relative w-full">
                        <select id="filter-jabatan" onchange="app.renderUser()" class="w-full pl-3 pr-6 py-2 bg-slate-50 border border-slate-200 rounded-lg text-[11px] font-bold text-slate-600 outline-none appearance-none truncate"><option value="">Semua Jabatan</option></select>
                        <i data-lucide="briefcase" class="absolute right-2 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-400 pointer-events-none"></i>
                    </div>
                </div>
                
                <div class="flex justify-between items-center pt-2 border-t border-slate-50 mt-1">
                    <div class="flex items-center gap-1 overflow-x-auto hide-scroll pb-1">
                        <button onclick="app.setFilterStatus('all')" id="btn-status-all" class="px-2.5 py-1.5 rounded-lg text-[10px] font-bold bg-slate-800 text-white whitespace-nowrap transition shadow-sm">Semua</button>
                        <button onclick="app.setFilterStatus('active')" id="btn-status-active" class="px-2.5 py-1.5 rounded-lg text-[10px] font-bold bg-slate-100 text-slate-500 hover:bg-green-100 hover:text-green-600 whitespace-nowrap transition">üü¢ Aktif</button>
                        <button onclick="app.setFilterStatus('inactive')" id="btn-status-inactive" class="px-2.5 py-1.5 rounded-lg text-[10px] font-bold bg-slate-100 text-slate-500 hover:bg-slate-200 whitespace-nowrap transition">‚ö´ Non</button>
                    </div>
                    <span id="user-count" class="text-[10px] font-extrabold text-slate-400 bg-slate-100 px-2 py-1 rounded-md shrink-0">... Data</span>
                </div>
            </div>
            <div id="list-user" class="space-y-3 pb-24"></div>
        </div>

        <div id="view-feedback" class="hidden space-y-4 pb-20">
            <div id="list-feedback" class="space-y-3"></div>
        </div>

    </main>

    <div id="modal-menu" class="fixed inset-0 z-[60] hidden flex items-end sm:items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl modal-content h-[85vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-lg text-slate-800">Editor Menu</h3>
                <button onclick="app.closeModal('modal-menu')" class="p-2 bg-slate-100 rounded-full hover:bg-slate-200"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="space-y-4">
                <input type="hidden" id="inp-id">
                <div><label class="block text-[10px] font-bold text-slate-400 uppercase">Judul Menu</label><input type="text" id="inp-judul" class="w-full border rounded-lg px-3 py-2.5 text-sm mt-1 focus:ring-2 focus:ring-blue-500 outline-none"></div>
                <div><label class="block text-[10px] font-bold text-slate-400 uppercase">Deskripsi Singkat</label><input type="text" id="inp-deskripsi" class="w-full border rounded-lg px-3 py-2.5 text-sm mt-1 focus:ring-2 focus:ring-blue-500 outline-none"></div>
                <div><label class="block text-[10px] font-bold text-slate-400 uppercase">URL Tujuan</label><input type="text" id="inp-url" class="w-full border rounded-lg px-3 py-2.5 text-sm mt-1 focus:ring-2 focus:ring-blue-500 outline-none font-mono text-xs"></div>
                
                <div class="p-3 bg-blue-50 rounded-xl border border-blue-100">
                    <label class="block text-[10px] font-bold text-blue-600 uppercase mb-1">Cara Buka Link</label>
                    <select id="inp-openMode" class="w-full bg-white border border-blue-200 rounded-lg px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">üåè Browser Luar / Chrome</option>
                        <option value="app">üì± Di Dalam Aplikasi (Popup)</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-[10px] font-bold text-slate-400 uppercase">Icon (Lucide)</label><input type="text" id="inp-icon" placeholder="cth: home" class="w-full border rounded-lg px-3 py-2.5 text-sm mt-1"></div>
                    <div><label class="block text-[10px] font-bold text-slate-400 uppercase">Warna</label><select id="inp-warna" class="w-full bg-white border rounded-lg px-3 py-2.5 text-sm mt-1"><option value="blue">Biru</option><option value="teal">Teal</option><option value="rose">Rose</option><option value="orange">Orange</option><option value="purple">Ungu</option><option value="slate">Abu-abu</option></select></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-[10px] font-bold text-slate-400 uppercase">Parent (Submenu)</label><input type="text" id="inp-parent" placeholder="Kosongkan jika utama" class="w-full border rounded-lg px-3 py-2.5 text-sm mt-1"></div>
                    <div><label class="block text-[10px] font-bold text-slate-400 uppercase">Tampil Di</label><select id="inp-target" class="w-full bg-white border rounded-lg px-3 py-2.5 text-sm mt-1"><option value="">Semua</option><option value="mobile">HP Saja</option><option value="desktop">PC Saja</option></select></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-[10px] font-bold text-slate-400 uppercase">Ukuran</label><select id="inp-ukuran" class="w-full bg-white border rounded-lg px-3 py-2.5 text-sm mt-1"><option value="">Normal</option><option value="wide">Lebar</option></select></div>
                    <div><label class="block text-[10px] font-bold text-slate-400 uppercase">Akses</label><select id="inp-role" class="w-full bg-white border rounded-lg px-3 py-2.5 text-sm mt-1"><option value="">Umum</option><option value="guru">Login Guru</option></select></div>
                </div>
                <div><label class="block text-[10px] font-bold text-slate-400 uppercase">Label Badge</label><input type="text" id="inp-label" placeholder="cth: Baru" class="w-full border rounded-lg px-3 py-2.5 text-sm mt-1"></div>
            </div>
            <div class="mt-8 flex gap-3 sticky bottom-0 bg-white pt-4 border-t border-slate-100">
                <button onclick="app.deleteMenu()" class="px-4 py-3 bg-red-50 text-red-600 font-bold rounded-xl text-sm hover:bg-red-100 transition"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                <button onclick="app.saveMenu()" class="flex-1 bg-slate-900 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition">Simpan Perubahan</button>
            </div>
        </div>
    </div>

    <script>
        const app = {
            // == PASTE URL DEPLOYMENT BERAKHIRAN /exec DI SINI ==
            url: "https://script.google.com/macros/s/AKfycbxvKz8ogmWbeUJWZbSFWnYHrXDr78nhdjakJsTETd8HkyIkMw2LOe-08pHcbxYLch7mRA/exec",
            
            data: {}, adminPin: "",
            currentStatusFilter: 'all',
            currentSort: 'default', // default | latest
            
            init: function() {
                if(localStorage.getItem('admin_pin')) {
                    this.adminPin = localStorage.getItem('admin_pin');
                    document.getElementById('login-screen').classList.add('hidden');
                    this.loadData();
                }
                lucide.createIcons();
            },
            
            checkAuth: function() {
                const pin = document.getElementById('admin-pin-input').value;
                if(pin === "123123") {
                    localStorage.setItem('admin_pin', pin);
                    this.adminPin = pin;
                    document.getElementById('login-screen').classList.add('hidden');
                    this.loadData();
                } else { alert("PIN Salah!"); }
            },
            
            logout: function() {
                if(confirm("Keluar dari Admin Panel?")) {
                    localStorage.removeItem('admin_pin');
                    location.reload();
                }
            },
            
            loadData: function(force=false) {
                const btn = document.getElementById('btn-refresh');
                const icon = btn.querySelector('i') || btn.querySelector('svg');
                if(icon) icon.classList.add('animate-spin');
                
                fetch(`${this.url}?action=admin_load&pin=${this.adminPin}`)
                .then(r => r.json())
                .then(d => {
                    if(d.status === 'error') { alert(d.message); localStorage.removeItem('admin_pin'); location.reload(); return; }
                    this.data = d;
                    this.renderMenu();
                    this.renderInfo();
                    this.initUserFilters();
                    this.renderUser();
                    this.renderFeedback();
                })
                .catch(e => { alert("Gagal memuat data. Cek koneksi."); console.error(e); })
                .finally(() => {
                    const iconFinal = btn.querySelector('svg');
                    if(iconFinal) setTimeout(() => iconFinal.classList.remove('animate-spin'), 500);
                });
            },
            
            switchTab: function(tab) {
                ['menu','info','user','feedback'].forEach(t => {
                    document.getElementById(`view-${t}`).classList.add('hidden');
                    const btn = document.getElementById(`tab-${t}`);
                    btn.classList.remove('bg-white', 'shadow-sm', 'text-slate-800');
                    btn.classList.add('text-slate-500');
                });
                document.getElementById(`view-${tab}`).classList.remove('hidden');
                const fab = document.getElementById('save-info-btn-container');
                if(tab === 'info') fab.classList.remove('hidden'); else fab.classList.add('hidden');
                const active = document.getElementById(`tab-${tab}`);
                active.classList.add('bg-white', 'shadow-sm', 'text-slate-800');
                active.classList.remove('text-slate-500');
            },
            
            // --- MENU FUNCTIONS ---
            renderMenu: function() {
                const c = document.getElementById('list-menu'); c.innerHTML = '';
                (this.data.raw_menu || []).slice(1).forEach((r, i) => {
                    if(!r[0]) return;
                    
                    const isApp = r[10] === 'app';
                    const isMobile = (r[5] || '').toLowerCase() === 'mobile';
                    const isGuru = (r[9] || '').toLowerCase() === 'guru';
                    
                    let badges = '';
                    if(isApp) badges += '<span class="flex items-center gap-1 bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded text-[9px] font-bold"><i data-lucide="smartphone" class="w-2.5 h-2.5"></i> In-App</span>';
                    if(isMobile) badges += '<span class="flex items-center gap-1 bg-orange-100 text-orange-700 px-1.5 py-0.5 rounded text-[9px] font-bold"><i data-lucide="tablet-smartphone" class="w-2.5 h-2.5"></i> HP Only</span>';
                    if(isGuru) badges += '<span class="flex items-center gap-1 bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded text-[9px] font-bold"><i data-lucide="lock" class="w-2.5 h-2.5"></i> Guru</span>';

                    const div = document.createElement('div');
                    div.className = "bg-white p-3.5 rounded-2xl border border-slate-100 shadow-sm flex items-center justify-between group hover:border-blue-200 hover:shadow-md transition cursor-default";
                    div.innerHTML = `
                        <div class="flex items-start gap-4 overflow-hidden">
                            <div class="w-12 h-12 shrink-0 rounded-xl bg-${r[4]}-50 text-${r[4]}-600 flex items-center justify-center border border-${r[4]}-100 shadow-sm">
                                <i data-lucide="${r[3]}" class="w-6 h-6 stroke-[1.5]"></i>
                            </div>
                            <div class="min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <h4 class="font-bold text-sm text-slate-800 truncate">${r[0]}</h4>
                                    ${r[8] ? `<span class="bg-red-500 text-white text-[9px] px-1.5 rounded font-bold">${r[8]}</span>` : ''}
                                </div>
                                <p class="text-[11px] text-slate-400 truncate max-w-[200px] mb-1.5">${r[1]}</p>
                                <div class="flex gap-1.5 flex-wrap">${badges}</div>
                            </div>
                        </div>
                        <button onclick="app.editMenu(${i + 1})" class="p-2.5 bg-slate-50 rounded-xl text-slate-400 hover:text-blue-600 hover:bg-blue-50 transition border border-transparent hover:border-blue-100"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                    `;
                    c.appendChild(div);
                });
                lucide.createIcons();
            },
            
            editMenu: function(idx) {
                document.getElementById('inp-id').value = idx;
                if(idx === -1) {
                    ['judul','deskripsi','url','icon','parent','label'].forEach(k=>document.getElementById(`inp-${k}`).value='');
                    document.getElementById('inp-warna').value='blue';
                    document.getElementById('inp-target').value='';
                    document.getElementById('inp-ukuran').value='';
                    document.getElementById('inp-role').value='';
                    document.getElementById('inp-openMode').value=''; 
                } else {
                    const r = this.data.raw_menu[idx];
                    const fields = ['judul','deskripsi','url','icon','warna','target','parent','ukuran','label','role','openMode'];
                    fields.forEach((f, i) => { const el = document.getElementById(`inp-${f}`); if(el) el.value = r[i]; });
                }
                const m = document.getElementById('modal-menu');
                m.classList.remove('hidden');
                setTimeout(()=>m.classList.add('modal-open'), 10);
            },
            saveMenu: function() {
                const id = document.getElementById('inp-id').value;
                const p = {
                    action: 'save_menu', admin_pin: this.adminPin, id: id,
                    judul: document.getElementById('inp-judul').value,
                    deskripsi: document.getElementById('inp-deskripsi').value,
                    url: document.getElementById('inp-url').value,
                    icon: document.getElementById('inp-icon').value,
                    warna: document.getElementById('inp-warna').value,
                    target: document.getElementById('inp-target').value,
                    parent: document.getElementById('inp-parent').value,
                    ukuran: document.getElementById('inp-ukuran').value,
                    label: document.getElementById('inp-label').value,
                    role: document.getElementById('inp-role').value,
                    openMode: document.getElementById('inp-openMode').value 
                };
                this.sendData(p);
            },
            deleteMenu: function() {
                if(!confirm("Hapus menu ini?")) return;
                this.sendData({ action: 'delete_menu', admin_pin: this.adminPin, id: document.getElementById('inp-id').value });
            },

            // --- INFO & FOOTER ---
            renderInfo: function() {
                const i = this.data.info;
                document.getElementById('inf-status').value = i.status;
                document.getElementById('inf-warna').value = i.warna;
                document.getElementById('inf-pesan').value = i.pesan;
                document.getElementById('inf-versi').value = i.versi;
                document.getElementById('pop-status').value = i.pop_status;
                document.getElementById('pop-judul').value = i.pop_judul;
                document.getElementById('pop-pesan').value = i.pop_pesan;
                document.getElementById('pop-gambar').value = i.pop_gambar;
                
                const fc = document.getElementById('footer-list-editor'); fc.innerHTML = '';
                (this.data.raw_footer || []).forEach((f, idx) => {
                    const d = document.createElement('div');
                    d.className = "bg-white p-3 rounded-xl border border-slate-200 shadow-sm flex flex-col gap-3 relative group";
                    d.innerHTML = `
                        <div class="flex gap-3 items-start">
                            <div class="w-10 h-10 bg-slate-50 rounded-lg flex items-center justify-center text-slate-400 shrink-0 border border-slate-100">
                                <i data-lucide="${f[2] || 'link'}" class="w-5 h-5"></i>
                            </div>
                            <div class="flex-1 space-y-2">
                                <input type="text" value="${f[0]}" placeholder="Judul Link" class="w-full text-xs font-bold text-slate-800 border-b border-dashed border-slate-300 pb-1 outline-none focus:border-blue-500" onchange="app.updateFooter(${idx}, 0, this.value)">
                                <input type="text" value="${f[1]}" placeholder="https://..." class="w-full text-[10px] text-blue-500 font-mono bg-slate-50 px-2 py-1 rounded outline-none" onchange="app.updateFooter(${idx}, 1, this.value)">
                            </div>
                        </div>
                        <div class="flex gap-2 items-center">
                            <span class="text-[10px] text-slate-400 font-bold uppercase">Icon:</span>
                            <input type="text" value="${f[2]}" class="flex-1 text-[10px] bg-white border border-slate-200 rounded px-2 py-1 outline-none text-slate-600" onchange="app.updateFooter(${idx}, 2, this.value)">
                            <button onclick="app.delFooter(${idx})" class="p-1.5 text-red-500 bg-red-50 rounded hover:bg-red-100"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                        </div>
                    `;
                    fc.appendChild(d);
                });
                lucide.createIcons();
            },
            saveInfo: function() {
                const p = {
                    action: 'save_info', admin_pin: this.adminPin,
                    status: document.getElementById('inf-status').value,
                    warna: document.getElementById('inf-warna').value,
                    pesan: document.getElementById('inf-pesan').value,
                    versi: document.getElementById('inf-versi').value,
                    pop_status: document.getElementById('pop-status').value,
                    pop_judul: document.getElementById('pop-judul').value,
                    pop_pesan: document.getElementById('pop-pesan').value,
                    pop_gambar: document.getElementById('pop-gambar').value
                };
                this.sendData(p);
            },

            // --- USER FUNCTIONS (SORT ADDED) ---
            initUserFilters: function() {
                const users = (this.data.users || []).slice(1);
                
                const unitSelect = document.getElementById('filter-unit');
                unitSelect.innerHTML = '<option value="">Semua Sekolah</option>';
                const units = [...new Set(users.map(u => u[4]).filter(Boolean))].sort();
                units.forEach(u => unitSelect.add(new Option(u, u)));

                const jabSelect = document.getElementById('filter-jabatan');
                jabSelect.innerHTML = '<option value="">Semua Jabatan</option>';
                const jobs = [...new Set(users.map(u => u[3]).filter(Boolean))].sort();
                jobs.forEach(j => jabSelect.add(new Option(j, j)));
            },

            setFilterStatus: function(status) {
                this.currentStatusFilter = status;
                ['all', 'active', 'inactive'].forEach(k => {
                    const btn = document.getElementById(`btn-status-${k}`);
                    if (k === status) btn.className = "px-2.5 py-1.5 rounded-lg text-[10px] font-bold bg-slate-800 text-white whitespace-nowrap transition shadow-sm";
                    else btn.className = "px-2.5 py-1.5 rounded-lg text-[10px] font-bold bg-slate-100 text-slate-500 hover:bg-slate-200 whitespace-nowrap transition";
                });
                this.renderUser();
            },

            toggleSort: function() {
                const btn = document.getElementById('btn-sort');
                const icon = btn.querySelector('svg'); // Get existing svg
                
                if (this.currentSort === 'default') {
                    this.currentSort = 'latest';
                    btn.classList.add('bg-blue-100', 'text-blue-600', 'border-blue-200');
                    // Change icon manually or just style
                    // For simplicity, we just change style active
                } else {
                    this.currentSort = 'default';
                    btn.classList.remove('bg-blue-100', 'text-blue-600', 'border-blue-200');
                }
                this.renderUser();
            },

            renderUser: function() {
                const c = document.getElementById('list-user'); c.innerHTML = '';
                const searchTerm = document.getElementById('search-user').value.toLowerCase();
                const unitFilter = document.getElementById('filter-unit').value;
                const jabFilter = document.getElementById('filter-jabatan').value;
                const users = (this.data.users || []).slice(1);
                
                let filtered = users.filter(u => {
                    const name = String(u[1]).toLowerCase();
                    const unit = String(u[4]); 
                    const jab = String(u[3]);
                    const lastLogin = u[6] && u[6].length > 5;
                    
                    const matchSearch = name.includes(searchTerm) || unit.toLowerCase().includes(searchTerm) || String(u[0]).toLowerCase().includes(searchTerm);
                    const matchUnit = unitFilter === "" || unit === unitFilter;
                    const matchJab = jabFilter === "" || jab === jabFilter;
                    
                    let matchStatus = true;
                    if (this.currentStatusFilter === 'active') matchStatus = lastLogin;
                    if (this.currentStatusFilter === 'inactive') matchStatus = !lastLogin;

                    return matchSearch && matchUnit && matchJab && matchStatus;
                });

                // SORTING LOGIC
                if (this.currentSort === 'latest') {
                    filtered.sort((a, b) => {
                        const dateA = a[6] ? new Date(a[6]) : new Date(0);
                        const dateB = b[6] ? new Date(b[6]) : new Date(0);
                        return dateB - dateA; // Descending (Newest First)
                    });
                    
                    // Update Icon Visual
                    const btnSort = document.getElementById('btn-sort');
                    btnSort.innerHTML = '<i data-lucide="clock" class="w-5 h-5"></i>';
                } else {
                    // Default Icon
                    const btnSort = document.getElementById('btn-sort');
                    btnSort.innerHTML = '<i data-lucide="arrow-down-up" class="w-5 h-5"></i>';
                }

                // COMPACT COUNT DISPLAY
                const countEl = document.getElementById('user-count');
                if(countEl) countEl.innerText = `${filtered.length} Data`;

                if (filtered.length === 0) {
                    c.innerHTML = '<div class="flex flex-col items-center justify-center py-10 text-slate-400 gap-2"><i data-lucide="search-x" class="w-8 h-8 opacity-50"></i><span class="text-xs font-medium">Tidak ada data ditemukan</span></div>';
                    lucide.createIcons(); return;
                }

                filtered.forEach(u => {
                    const isActive = u[6] && u[6].length > 5;
                    const opacityClass = isActive ? '' : 'opacity-60 grayscale-[0.5]';
                    const badge = isActive 
                        ? '<span class="text-[9px] font-bold bg-green-100 text-green-700 px-2 py-0.5 rounded-full flex items-center gap-1"><span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> Aktif</span>'
                        : '<span class="text-[9px] font-bold bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full">Non-Aktif</span>';

                    const div = document.createElement('div');
                    div.className = `bg-white p-4 rounded-2xl border border-slate-100 shadow-sm transition hover:shadow-md ${opacityClass}`;
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-sm text-slate-800 truncate pr-2">${u[1]}</h4>
                            ${badge}
                        </div>
                        <div class="flex flex-wrap items-center gap-2 mb-3">
                            <span class="bg-blue-50 text-blue-600 text-[10px] px-2 py-0.5 rounded-md font-bold truncate border border-blue-100">${u[4]}</span>
                            <span class="text-[10px] text-slate-500 border border-slate-200 px-2 py-0.5 rounded-md">${u[3]}</span>
                        </div>
                        <div class="text-[10px] text-slate-400 flex items-center justify-between pt-2 border-t border-slate-50">
                            <span class="flex items-center gap-1 truncate max-w-[150px]"><i data-lucide="mail" class="w-3 h-3"></i> ${u[0]}</span>
                            <span class="${isActive ? 'text-green-600 font-bold' : 'text-slate-300'} flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> ${isActive ? app.fmtDate(u[6]) : '-'}</span>
                        </div>
                    `;
                    c.appendChild(div);
                });
                lucide.createIcons();
            },

            // --- FEEDBACK ---
            renderFeedback: function() {
                const c = document.getElementById('list-feedback'); c.innerHTML = '';
                (this.data.feedback || []).forEach(f => {
                    const div = document.createElement('div');
                    div.className = "bg-white p-4 rounded-xl border border-slate-100 shadow-sm";
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[10px] font-bold ${f[1]=='Bug'?'text-red-600 bg-red-100':'text-green-600 bg-green-100'} px-2 py-0.5 rounded-md">${f[1]}</span>
                            <span class="text-[10px] text-slate-400 font-mono">${app.fmtDate(f[0])}</span>
                        </div>
                        <p class="text-sm text-slate-700 font-medium mb-3 leading-relaxed">"${f[2]}"</p>
                        <div class="flex items-center justify-between border-t border-slate-50 pt-2">
                            <div class="flex items-center gap-2 text-xs text-slate-500 font-bold">
                                <div class="w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center text-slate-400"><i data-lucide="user" class="w-3 h-3"></i></div>
                                ${f[4]} <span class="font-normal text-slate-400">(${f[5]})</span>
                            </div>
                            <span class="flex items-center gap-1 text-orange-400 font-bold text-xs bg-orange-50 px-2 py-1 rounded-lg"><i data-lucide="star" class="w-3 h-3 fill-current"></i> ${f[3]}</span>
                        </div>
                    `;
                    c.appendChild(div);
                });
                lucide.createIcons();
            },

            // --- UTILS ---
            openModal: function(id) { const m=document.getElementById(id); m.classList.remove('hidden'); setTimeout(()=>m.classList.add('modal-open'),10); },
            closeModal: function(id) { const m=document.getElementById(id); m.classList.remove('modal-open'); setTimeout(()=>m.classList.add('hidden'),200); },
            fmtDate: function(s) { if(!s||s.length<5)return'-'; try{return new Intl.DateTimeFormat('id-ID',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'}).format(new Date(s))}catch{return s} },
            updateFooter: function(idx, col, val) { this.data.raw_footer[idx][col] = val; },
            delFooter: function(idx) { if(!confirm("Hapus link?")) return; this.sendData({action:'delete_footer', admin_pin: this.adminPin, id: idx}); },
            addFooterItem: function() { this.sendData({ action: 'save_footer', admin_pin: this.adminPin, id: -1, judul: 'Link Baru', url: '#', icon: 'link' }); },
            sendData: function(p) { 
                const l=document.createElement('div');l.className="fixed inset-0 z-[220] bg-black/50 flex items-center justify-center text-white backdrop-blur-sm animate-fade-in";l.innerHTML="<div class='bg-white text-slate-800 p-6 rounded-2xl flex gap-4 shadow-2xl items-center'><i data-lucide='loader-2' class='animate-spin text-blue-600 w-6 h-6'></i><span class='font-bold'>Menyimpan...</span></div>";document.body.appendChild(l); lucide.createIcons();
                fetch(this.url,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},body:JSON.stringify(p)})
                .then(()=>{ setTimeout(()=>{ document.body.removeChild(l); setTimeout(()=>location.reload(),500); }, 1500); });
            }
        };

        document.addEventListener('DOMContentLoaded', ()=>app.init());
    </script>
</body>
</html>